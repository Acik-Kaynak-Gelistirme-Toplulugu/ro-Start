name: Build Release Packages

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  build-deb:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [amd64, arm64]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            dpkg-dev \
            debhelper \
            dh-python \
            python3-all \
            python3-setuptools \
            python3-pip

      - name: Build Frontend
        run: |
          cd frontend
          npm ci
          npm run build
          cd ..

      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install build

      - name: Create package structure
        run: |
          VERSION=$(grep "version" pyproject.toml | head -1 | cut -d'"' -f2)
          ARCH=${{ matrix.arch }}
          PKG_NAME="ro-start_${VERSION}_${ARCH}"

          mkdir -p ${PKG_NAME}/DEBIAN
          mkdir -p ${PKG_NAME}/usr/bin
          mkdir -p ${PKG_NAME}/usr/share/ro-start
          mkdir -p ${PKG_NAME}/usr/share/applications
          mkdir -p ${PKG_NAME}/usr/share/icons/hicolor/256x256/apps

          # Copy application files
          cp -r backend ${PKG_NAME}/usr/share/ro-start/
          cp -r frontend/dist ${PKG_NAME}/usr/share/ro-start/frontend/
          cp requirements.txt ${PKG_NAME}/usr/share/ro-start/
          cp pyproject.toml ${PKG_NAME}/usr/share/ro-start/

          # Copy desktop file
          cp ro-start.desktop ${PKG_NAME}/usr/share/applications/

          # Copy icon if exists
          if [ -f assets/welcome_screen.png ]; then
            cp assets/welcome_screen.png ${PKG_NAME}/usr/share/icons/hicolor/256x256/apps/ro-start.png
          fi

          # Create wrapper script
          cat > ${PKG_NAME}/usr/bin/ro-start << 'EOF'
          #!/bin/bash
          cd /usr/share/ro-start
          exec python3 backend/main.py "$@"
          EOF
          chmod +x ${PKG_NAME}/usr/bin/ro-start

          # Create control file
          cat > ${PKG_NAME}/DEBIAN/control << EOF
          Package: ro-start
          Version: ${VERSION}
          Architecture: ${ARCH}
          Maintainer: Emir <emir@osdev.shop>
          Depends: python3 (>= 3.9), python3-pyqt6, python3-pyqt6.qtwebengine, python3-psutil
          Section: utils
          Priority: optional
          Homepage: https://github.com/Acik-Kaynak-Gelistirme-Toplulugu/ro-start
          Description: Modern welcome application for Linux distributions
           Ro-Start is a next-generation welcome screen with a Liquid Glass aesthetic.
           Built with a hybrid architecture combining Python (PyQt6) and React.
          EOF

          # Create postinst script
          cat > ${PKG_NAME}/DEBIAN/postinst << 'EOF'
          #!/bin/bash
          set -e

          # Install Python dependencies
          pip3 install --break-system-packages darkdetect platformdirs 2>/dev/null || \
          pip3 install --user darkdetect platformdirs

          exit 0
          EOF
          chmod +x ${PKG_NAME}/DEBIAN/postinst

          # Build the package
          dpkg-deb --build ${PKG_NAME}

          echo "PKG_NAME=${PKG_NAME}" >> $GITHUB_ENV

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ro-start-${{ matrix.arch }}-deb
          path: "*.deb"

  create-release:
    needs: build-deb
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/**/*.deb
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
